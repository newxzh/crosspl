{
  "Task_id": 48,
  "Github_ID": "216849756",
  "Github_Project_Name": "v2board",
  "Programming_Language": "PHP",
  "suffix": ".php",
  "Interface_class": "IPC",
  "Interface_name": "HTTP client using cURL in PHP",
  "Instruction": "Task Description: Implement a PHP class for interacting with the BTCPay payment gateway to create invoices and process payments.\n\nClass Description: The BTCPay class encapsulates functionality for communicating with the BTCPay server API. It handles authentication, request formatting, and response processing for invoice creation.\n\nAttributes:\n- config: [array] - Stores configuration parameters including BTCPay server URL, store ID, and API key\n\nMethods:\n- __construct($config): [void] - Initializes the class with configuration parameters\n  - $config: [array] - Configuration array containing:\n    - btcpay_url: [string] - Base URL of BTCPay server\n    - btcpay_storeId: [string] - Store identifier\n    - btcpay_api_key: [string] - API authentication token\n\n- pay($order): [array] - Creates a payment invoice in BTCPay\n  - $order: [array] - Order details containing:\n    - total_amount: [numeric] - Order amount in smallest currency unit (e.g., cents)\n    - trade_no: [string] - Unique order identifier\n  - Returns: [array] - Payment response containing:\n    - type: [integer] - Response type identifier\n    - data: [string] - Checkout URL for payment\n\n- _curlPost($url, $params): [string] - Internal method for making HTTP POST requests\n  - $url: [string] - API endpoint URL\n  - $params: [string|false] - JSON-encoded request body or false for empty body\n  - Returns: [string] - Raw API response",
  "Canonical_solution": "namespace App\\Payments;\n\nclass BTCPay {\n    private $config;\n\n    public function __construct($config) {\n        $this->config = $config;\n    }\n\n    public function pay($order) {\n        $params = [\n            'jsonResponse' => true,\n            'amount' => sprintf('%.2f', $order['total_amount'] / 100),\n            'currency' => 'CNY',\n            'metadata' => [\n                'orderId' => $order['trade_no']\n            ]\n        ];\n\n        $params_string = @json_encode($params);\n        $ret_raw = $this->_curlPost($this->config['btcpay_url'] . 'api/v1/stores/' . $this->config['btcpay_storeId'] . '/invoices', $params_string);\n        $ret = @json_decode($ret_raw, true);\n        \n        if(empty($ret['checkoutLink'])) {\n            abort(500, \"error!\");\n        }\n        return [\n            'type' => 1,\n            'data' => $ret['checkoutLink'],\n        ];\n    }\n\n    private function _curlPost($url, $params=false) {\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_HEADER, 0);\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n        curl_setopt($ch, CURLOPT_TIMEOUT, 300);\n        curl_setopt($ch, CURLOPT_POSTFIELDS, $params);\n        curl_setopt(\n            $ch, \n            CURLOPT_HTTPHEADER, \n            array(\n                'Authorization:' .'token '.$this->config['btcpay_api_key'], \n                'Content-Type: application/json'\n            )\n        );\n        $result = curl_exec($ch);\n        curl_close($ch);\n        return $result;\n    }\n}",
  "FSMID_for_test": 132,
  "Code_level": "Class-level"
}
{
  "Task_id": 125,
  "Github_ID": "40277672",
  "Github_Project_Name": "phpspider",
  "Programming_Language": "PHP",
  "suffix": ".php",
  "Interface_class": "IPC",
  "Interface_name": "Redis in PHP",
  "Instruction": "Task Description: Create a PHP class that provides a Redis-based queue management system with connection handling, basic Redis operations, and error recovery mechanisms.\n\nClass Description: The `queue` class is a Redis wrapper that manages connections to Redis servers and provides common Redis operations with automatic reconnection on failure. It supports multiple Redis connections, connection pooling, and prefixing of keys.\n\nAttributes:\n- `$redis`: [static, mixed] - Placeholder for Redis instance (deprecated in favor of `$links`)\n- `$configs`: [static, array] - Stores configuration for different Redis connections\n- `$links`: [static, array] - Maintains active Redis connections\n- `$link_name`: [static, string] - Current connection name (defaults to 'default')\n- `$prefix`: [static, string] - Default prefix for Redis keys\n- `$error`: [static, string] - Stores the last error message\n\nMethods:\n- `init()` -> [bool|Redis] - Initializes Redis connection using current configuration. Returns Redis instance or false on failure.\n- `set($key, $value, $expire = 0)` -> [bool|null] - Sets a key-value pair in Redis with optional expiration. Returns true on success, null on failure.\n- `get($key)` -> [mixed|null] - Retrieves a value by key from Redis. Returns the value or null on failure.\n- `del($key)` -> [int|null] - Deletes a key from Redis. Returns number of deleted keys or null on failure.\n- `_get_default_config()` -> [array] - Retrieves default Redis configuration from global settings.\n- `clear_link()` -> [void] - Closes all active Redis connections and clears the connection pool.\n\nInput:\n- Configuration via `$GLOBALS['config']['redis']` for default connection\n- Method parameters as described above\n\nOutput:\n- For connection methods: Redis instance or boolean\n- For data operations: Various return types as described above\n- Error messages stored in `$error` property",
  "Canonical_solution": "namespace phpspider\\core;\n\nuse Exception;\nuse Redis;\n\nclass queue\n{\n    protected static $redis = NULL;\n    protected static $configs = array();\n    private static $links = array();\n    private static $link_name = 'default';\n    public static $prefix = 'phpspider';\n    public static $error = '';\n\n    public static function init()\n    {\n        if (!extension_loaded('redis'))\n        {\n            self::$error = 'The redis extension was not found';\n            return false;\n        }\n\n        $config = self::$link_name == 'default' ? self::_get_default_config() : self::$configs[self::$link_name];\n\n        if (empty(self::$links[self::$link_name]))\n        {\n            self::$links[self::$link_name] = new Redis();\n            if (strstr($config['host'], '.sock'))\n            {\n                if (!self::$links[self::$link_name]->connect($config['host']))\n                {\n                    self::$error = 'Unable to connect to redis server';\n                    unset(self::$links[self::$link_name]);\n                    return false;\n                }\n            }\n            else\n            {\n                if (!self::$links[self::$link_name]->connect($config['host'], $config['port'], $config['timeout']))\n                {\n                    self::$error = 'Unable to connect to redis server';\n                    unset(self::$links[self::$link_name]);\n                    return false;\n                }\n            }\n\n            if ($config['pass'])\n            {\n                if (!self::$links[self::$link_name]->auth($config['pass']))\n                {\n                    self::$error = 'Redis Server authentication failed';\n                    unset(self::$links[self::$link_name]);\n                    return false;\n                }\n            }\n\n            $prefix = empty($config['prefix']) ? self::$prefix : $config['prefix'];\n            self::$links[self::$link_name]->setOption(Redis::OPT_PREFIX, $prefix.':');\n            self::$links[self::$link_name]->setOption(Redis::OPT_READ_TIMEOUT, -1);\n            self::$links[self::$link_name]->select($config['db']);\n        }\n\n        return self::$links[self::$link_name];\n    }\n\n    public static function set($key, $value, $expire = 0)\n    {\n        self::init();\n        try\n        {\n            if (self::$links[self::$link_name])\n            {\n                if ($expire > 0)\n                {\n                    return self::$links[self::$link_name]->setex($key, $expire, $value);\n                }\n                else\n                {\n                    return self::$links[self::$link_name]->set($key, $value);\n                }\n            }\n        }\n        catch (Exception $e)\n        {\n            $msg = \"PHP Fatal error:  Uncaught exception 'RedisException' with message '\".$e->getMessage().\"'\\n\";\n            log::warn($msg);\n            if ($e->getCode() == 0) \n            {\n                self::$links[self::$link_name]->close();\n                self::$links[self::$link_name] = null;\n                usleep(100000);\n                return self::set($key, $value, $expire);\n            }\n        }\n        return NULL;\n    }\n\n    public static function get($key)\n    {\n        self::init();\n        try\n        {\n            if (self::$links[self::$link_name])\n            {\n                return self::$links[self::$link_name]->get($key);\n            }\n        }\n        catch (Exception $e)\n        {\n            $msg = \"PHP Fatal error:  Uncaught exception 'RedisException' with message '\".$e->getMessage().\"'\\n\";\n            log::warn($msg);\n            if ($e->getCode() == 0) \n            {\n                self::$links[self::$link_name]->close();\n                self::$links[self::$link_name] = null;\n                usleep(100000);\n                return self::get($key);\n            }\n        }\n        return NULL;\n    }\n\n    public static function del($key)\n    {\n        self::init();\n        try\n        {\n            if (self::$links[self::$link_name])\n            {\n                return self::$links[self::$link_name]->del($key);\n            }\n        }\n        catch (Exception $e)\n        {\n            $msg = \"PHP Fatal error:  Uncaught exception 'RedisException' with message '\".$e->getMessage().\"'\\n\";\n            log::warn($msg);\n            if ($e->getCode() == 0) \n            {\n                self::$links[self::$link_name]->close();\n                self::$links[self::$link_name] = null;\n                usleep(100000);\n                return self::del($key);\n            }\n        }\n        return NULL;\n    }\n\n    protected static function _get_default_config()\n    {\n        if (empty(self::$configs['default']))\n        {\n            if (!is_array($GLOBALS['config']['redis']))\n            {\n                exit('cls_redis.php _get_default_config()' . '\u6ca1\u6709redis\u914d\u7f6e');\n            }\n            self::$configs['default'] = $GLOBALS['config']['redis'];\n        }\n        return self::$configs['default'];\n    }\n\n    public static function clear_link()\n    {\n        if(self::$links) \n        {\n            foreach(self::$links as $k=>$v)\n            {\n                $v->close();\n                unset(self::$links[$k]);\n            }\n        }\n    }\n}",
  "FSMID_for_test": 144,
  "Code_level": "Class-level"
}